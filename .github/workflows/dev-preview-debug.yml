name: Dev-Preview Release

on:
  push:
    branches: [ "dev-preview" ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    environment: dev-preview  # ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼ˆå¯é€‰ï¼‰

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'  # å¯ç”¨Gradleç¼“å­˜

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        # ä¸å†éœ€è¦æ‰‹åŠ¨æ¥å—è®¸å¯è¯

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew :composeApp:assembleDebug
        env:
          KEYSTORE_PASSWORD: ${{ secrets.DEBUG_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.DEBUG_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.DEBUG_KEY_PASSWORD }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-preview-apk
          path: composeApp/build/outputs/apk/debug/*.apk
          retention-days: 1  # ä¸´æ—¶å­˜å‚¨

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          files: composeApp/build/outputs/apk/debug/*.apk
          tag_name: "dev-preview"
          name: "Dev-Preview Build (${GITHUB_SHA:0:7})"  # çŸ­æäº¤å“ˆå¸Œ
          body: |
            ### ğŸ“± è‡ªåŠ¨æ„å»ºé¢„è§ˆç‰ˆ
            | ä¿¡æ¯ | å€¼ |
            |------|-----|
            | åˆ†æ”¯ | ${{ github.ref_name }} |
            | æäº¤ | [${GITHUB_SHA:0:7}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
            | æ„å»ºæ—¶é—´ | ${{ format('{0}', github.event.head_commit.timestamp) }} |

            ### ğŸ“¥ ä¸‹è½½
            APK å·²è‡ªåŠ¨ç­¾åï¼ˆDebugè¯ä¹¦ï¼‰
          prerelease: true
          overwrite: true
          generate_release_notes: true  # è‡ªåŠ¨ç”ŸæˆåŸºç¡€Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
