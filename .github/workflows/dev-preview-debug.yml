name: å¼€å‘é¢„è§ˆç‰ˆå‘å¸ƒ

on:
  push:
    branches: [ "dev-preview" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆå…³é”®ä¿®å¤ï¼šä¿ç•™æ–‡ä»¶æƒé™ï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # é¿å…æƒé™å†²çª

      # 2. ä¿®å¤gradlewæƒé™ï¼ˆå¿…é¡»æ­¥éª¤ï¼ï¼‰
      - name: è®¾ç½®æ–‡ä»¶æƒé™
        run: |
          chmod +x gradlew
          ls -la gradlew  # éªŒè¯æƒé™ï¼ˆè°ƒè¯•ç”¨ï¼‰

      # 3. é…ç½®JDKï¼ˆå¸¦ç¼“å­˜ï¼‰
      - name: é…ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 4. é…ç½®Androidç¯å¢ƒ
      - name: é…ç½®Android SDK
        uses: android-actions/setup-android@v3

      # 5. æ„å»ºAPKï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      - name: æ„å»ºDebug APK
        run: ./gradlew :composeApp:assembleDebug --no-daemon --stacktrace
        env:
          KEYSTORE_PASSWORD: ${{ secrets.DEBUG_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.DEBUG_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.DEBUG_KEY_PASSWORD }}

      # 6. è·å–æ„å»ºä¿¡æ¯ï¼ˆç”¨äºReleaseè¯´æ˜ï¼‰
      - name: æ”¶é›†æ„å»ºä¿¡æ¯
        id: build-info
        run: |
          echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "commit_short=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

      # 7. åˆ›å»º/æ›´æ–°Releaseï¼ˆæ ¸å¿ƒï¼ï¼‰
      - name: å‘å¸ƒåˆ°GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # å¿…é¡»ä¼ é€’token
        with:
          tag_name: "dev-preview"
          name: "å¼€å‘é¢„è§ˆç‰ˆ (${{ steps.build-info.outputs.commit_short }}) | Dev Preview (${{ steps.build-info.outputs.commit_short }}) | ĞŸÑ€ĞµĞ²ÑŒÑ (${{ steps.build-info.outputs.commit_short }})"
          body: |
            ## âš ï¸ é‡è¦è¯´æ˜ | Important Notice | Ğ’Ğ°Ğ¶Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ
            
            **ä¸­æ–‡**  
            æ­¤ä¸ºæœ€æ–°å¼€å‘é¢„è§ˆç‰ˆï¼Œä»…ç”¨äºæµ‹è¯•ç›®çš„ã€‚  
            å¯èƒ½å­˜åœ¨ä¸ç¨³å®šé—®é¢˜ï¼Œ**ä¸é€‚åˆæ—¥å¸¸ä½¿ç”¨**ã€‚  
            è¯·å‹¿ä½œä¸ºä¸»åŠ›ç‰ˆæœ¬é•¿æœŸä½¿ç”¨ã€‚  
            
            **English**  
            This is the latest development preview for **TESTING PURPOSES ONLY**.  
            May contain unstable features, **NOT SUITABLE for daily use**.  
            Do not use as your primary version.  
            
            **Ğ ÑƒÑÑĞºĞ¸Ğ¹**  
            Ğ­Ñ‚Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ-Ğ²ĞµÑ€ÑĞ¸Ñ **Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ”Ğ›Ğ¯ Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯**.  
            ĞœĞ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ½ĞµÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸, **ĞĞ• ĞŸĞĞ”Ğ¥ĞĞ”Ğ˜Ğ¢ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²ÑĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ**.  
            ĞĞµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ĞºĞ°Ğº Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ.  
            
            ## ğŸ“Š æ„å»ºä¿¡æ¯ | Build Info | Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ±Ğ¾Ñ€ĞºĞµ
            
            | é¡¹ç›®/Item/ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | å€¼/Value/Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
            |------|----|
            | åˆ†æ”¯/Branch/Ğ’ĞµÑ‚ĞºĞ° | ${{ github.ref_name }} |
            | æäº¤/Commit/ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ | [${{ steps.build-info.outputs.commit_short }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
            | æ„å»ºæ—¶é—´/Build Time/Ğ’Ñ€ĞµĞ¼Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ | ${{ steps.build-info.outputs.time }} |
            | æ„å»ºç¼–å·/Build Number/ĞĞ¾Ğ¼ĞµÑ€ ÑĞ±Ğ¾Ñ€ĞºĞ¸ | ${{ github.run_number }} |

          files: composeApp/build/outputs/apk/debug/*.apk
          prerelease: true
          overwrite: true
          generate_release_notes: true